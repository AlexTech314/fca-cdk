// Prisma schema for FCA API
// https://pris.ly/d/prisma-schema

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-arm64-openssl-3.0.x", "rhel-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ===========================================
// USER & AUTH
// ===========================================

model User {
  id             String    @id @default(uuid())
  email          String    @unique
  name           String?
  cognitoSub     String?   @unique @map("cognito_sub")
  role           String    @default("readonly") // readonly, readwrite, admin
  lastActiveAt   DateTime? @map("last_active_at")
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  @@map("users")
}

// ===========================================
// WEBSITE CONTENT
// ===========================================

model Tombstone {
  id              String    @id @default(uuid())
  name            String                          // Company/Seller name
  slug            String    @unique               // URL-friendly identifier
  assetId         String?   @map("asset_id")      // FK to Asset (tombstone image)
  asset           Asset?    @relation(fields: [assetId], references: [id], onDelete: SetNull)
  industry        String?                         // Industry category
  role            String?                         // Buy-side or Sell-side

  // Extended fields (from CSV data)
  buyerPeFirm     String?   @map("buyer_pe_firm")     // PE firm
  buyerPlatform   String?   @map("buyer_platform")    // Platform company
  transactionYear Int?      @map("transaction_year")  // Year of deal
  city            String?
  state           String?

  // Press release (1-to-1 relationship with BlogPost)
  pressReleaseId  String?   @unique @map("press_release_id")
  pressRelease    BlogPost? @relation(fields: [pressReleaseId], references: [id], onDelete: SetNull)

  sortOrder       Int       @default(0) @map("sort_order")
  isPublished     Boolean   @default(true) @map("is_published")
  previewToken    String    @unique @default(uuid()) @map("preview_token")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  // Many-to-many relationship with content tags
  tags            TombstoneTag[]

  @@index([transactionYear])
  @@index([industry])
  @@index([state])
  @@map("tombstones")
}

model BlogPost {
  id           String    @id @default(uuid())
  slug         String    @unique
  title        String
  excerpt      String?
  content      String                          // Markdown content
  author       String?
  category     String?                         // news, resource, article
  publishedAt  DateTime? @map("published_at")
  isPublished  Boolean   @default(false) @map("is_published")
  previewToken String    @unique @default(uuid()) @map("preview_token")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  // 1-to-1 reverse relation (this blog post is the press release for a tombstone)
  tombstone    Tombstone?

  // Many-to-many relationship with content tags
  tags         BlogPostTag[]

  @@index([category, isPublished])
  @@map("blog_posts")
}

// ===========================================
// CONTENT TAGS (for related content discovery)
// ===========================================

model ContentTag {
  id          String   @id @default(uuid())
  name        String   @unique               // Display name
  slug        String   @unique               // URL-friendly version
  category    String?                        // industry, service-type, deal-type
  description String?
  keywords    String[] @default([])          // Keywords for content matching
  createdAt   DateTime @default(now()) @map("created_at")

  tombstones  TombstoneTag[]
  blogPosts   BlogPostTag[]

  @@map("content_tags")
}

model TombstoneTag {
  tombstoneId String @map("tombstone_id")
  tagId       String @map("tag_id")

  tombstone   Tombstone  @relation(fields: [tombstoneId], references: [id], onDelete: Cascade)
  tag         ContentTag @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([tombstoneId, tagId])
  @@index([tagId])
  @@map("tombstone_tags")
}

model BlogPostTag {
  blogPostId String @map("blog_post_id")
  tagId      String @map("tag_id")

  blogPost   BlogPost   @relation(fields: [blogPostId], references: [id], onDelete: Cascade)
  tag        ContentTag @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([blogPostId, tagId])
  @@index([tagId])
  @@map("blog_post_tags")
}

model PageContent {
  id           String   @id @default(uuid())
  pageKey      String   @unique @map("page_key") // home, about, faq, contact, etc.
  title        String
  content      String   @default("")             // Markdown or prose content
  metadata     Json?                             // SEO metadata, hero settings, structured data
  previewToken String   @unique @default(uuid()) @map("preview_token")
  updatedAt    DateTime @updatedAt @map("updated_at")

  @@map("page_content")
}

// ===========================================
// ANALYTICS
// ===========================================

model PageView {
  id        String   @id @default(uuid())
  path      String
  hour      DateTime                          // Truncated to hour for aggregation
  count     Int      @default(1)
  createdAt DateTime @default(now()) @map("created_at")

  @@unique([path, hour])
  @@index([hour])
  @@map("page_views")
}

// ===========================================
// EMAIL & NEWSLETTER
// ===========================================

model EmailSubscriber {
  id             String    @id @default(uuid())
  email          String    @unique
  name           String?
  source         String?                        // website, intake_form, manual
  isSubscribed   Boolean   @default(true) @map("is_subscribed")
  subscribedAt   DateTime  @default(now()) @map("subscribed_at")
  unsubscribedAt DateTime? @map("unsubscribed_at")

  @@map("email_subscribers")
}

model SellerIntake {
  id             String   @id @default(uuid())

  // Contact Information
  firstName      String   @map("first_name")
  lastName       String   @map("last_name")
  email          String
  phone          String?

  // Company Information
  companyName    String   @map("company_name")
  title          String?                        // Their role (Owner, CEO, CFO, etc.)
  industry       String?
  city           String?
  state          String?

  // Business Details
  revenueRange   String?  @map("revenue_range")
  employeeCount  String?  @map("employee_count")

  // Transaction Interest
  timeline       String?
  serviceInterest String? @map("service_interest")

  // Additional
  message        String?
  source         String?                        // Which form/page
  referralSource String?  @map("referral_source")

  // Internal Tracking
  status         String   @default("new")       // new, contacted, qualified, engaged, closed
  notes          String?
  assignedTo     String?  @map("assigned_to")

  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  @@index([status])
  @@index([createdAt])
  @@map("seller_intakes")
}

model EmailNotification {
  id             String   @id @default(uuid())
  type           String                          // new_tombstone, new_blog_post
  referenceId    String   @map("reference_id")
  sentAt         DateTime @default(now()) @map("sent_at")
  recipientCount Int      @map("recipient_count")

  @@map("email_notifications")
}

// ===========================================
// STATIC PAGE CONTENT
// ===========================================

model TeamMember {
  id          String   @id @default(uuid())
  name        String
  title       String
  image       String?                           // Path to team member photo
  bio         String                            // Full biography text
  email       String?
  linkedIn    String?  @map("linkedin")
  category    String   @default("leadership")   // leadership, analyst
  sortOrder   Int      @default(0) @map("sort_order")
  isPublished Boolean  @default(true) @map("is_published")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@index([category, sortOrder])
  @@map("team_members")
}

model CommunityService {
  id          String   @id @default(uuid())
  name        String
  description String
  url         String
  sortOrder   Int      @default(0) @map("sort_order")
  isPublished Boolean  @default(true) @map("is_published")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("community_services")
}

model FAQ {
  id          String   @id @default(uuid())
  question    String
  answer      String
  sortOrder   Int      @default(0) @map("sort_order")
  isPublished Boolean  @default(true) @map("is_published")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("faqs")
}

model CoreValue {
  id          String   @id @default(uuid())
  title       String
  description String
  icon        String                            // Path to icon image
  sortOrder   Int      @default(0) @map("sort_order")
  isPublished Boolean  @default(true) @map("is_published")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("core_values")
}

model IndustrySector {
  id          String   @id @default(uuid())
  name        String
  description String
  sortOrder   Int      @default(0) @map("sort_order")
  isPublished Boolean  @default(true) @map("is_published")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("industry_sectors")
}

model ServiceOffering {
  id          String   @id @default(uuid())
  title       String
  description String?
  category    String                            // sell-side, buy-side, strategic
  type        String   @default("service")      // service, process-step, benefit, disadvantage
  step        Int?                              // For process steps (1, 2, 3, 4)
  sortOrder   Int      @default(0) @map("sort_order")
  isPublished Boolean  @default(true) @map("is_published")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@index([category, type, sortOrder])
  @@map("service_offerings")
}

model SiteConfig {
  id            String   @id @default("default")  // Single-row config
  name          String                            // Company name
  tagline       String?
  url           String                            // Website URL
  description   String?
  phone         String?
  email         String?
  linkedIn      String?  @map("linkedin")
  ogImage       String?  @map("og_image")
  locations     Json     @default("[]")           // [{city, state}]
  navItems      Json     @default("[]")           // [{name, href}]
  footerNav     Json     @default("{}")           // {services: [], company: [], resources: []}
  serviceTypes  Json     @default("[]") @map("service_types")   // ["Mergers and Acquisitions Advisory", ...]
  companyBlurb  String?  @map("company_blurb")                  // Short company description for sidebars
  updatedAt     DateTime @updatedAt @map("updated_at")

  @@map("site_config")
}

model Award {
  id          String   @id @default(uuid())
  name        String                            // Display name (e.g. "Axial Top 10 Investment Bank 2022")
  image       String                            // URL or path to award image
  sortOrder   Int      @default(0) @map("sort_order")
  isPublished Boolean  @default(true) @map("is_published")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("awards")
}

// ===========================================
// LEAD GENERATION
// ===========================================

model SearchQuery {
  id           String    @id @default(uuid())
  textQuery    String    @map("text_query")
  includedType String?   @map("included_type")
  campaignId   String    @map("campaign_id")
  campaign     Campaign  @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  campaignRunId String?   @map("campaign_run_id")
  campaignRun   CampaignRun? @relation(fields: [campaignRunId], references: [id], onDelete: SetNull)

  createdAt    DateTime  @default(now()) @map("created_at")

  leads        Lead[]

  @@index([campaignId])
  @@index([campaignRunId])
  @@index([textQuery])
  @@map("search_queries")
}

model Franchise {
  id          String   @id @default(uuid())
  name        String   // normalized for matching (e.g. "xyz plumbing")
  displayName String?  @map("display_name")  // original (e.g. "XYZ Plumbing")

  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  leads       Lead[]

  @@unique([name])
  @@map("franchises")
}

model Job {
  id             String    @id @default(uuid())
  campaignId     String?   @map("campaign_id")
  campaign       Campaign? @relation(fields: [campaignId], references: [id], onDelete: SetNull)
  campaignRunId  String?   @map("campaign_run_id")
  campaignRun    CampaignRun? @relation(fields: [campaignRunId], references: [id], onDelete: SetNull)

  type           String    // places_search, web_scrape, score_leads, prepare_scrape
  status         String    @default("pending")  // pending, running, completed, failed
  startedAt      DateTime? @map("started_at")
  completedAt    DateTime? @map("completed_at")
  externalId     String?   @map("external_id")  // ECS task ARN, Step Functions exec ARN, etc.
  errorMessage   String?   @map("error_message")
  metadata       Json?

  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  @@index([campaignId])
  @@index([campaignRunId])
  @@index([type])
  @@index([status])
  @@index([createdAt])
  @@map("jobs")
}

model Lead {
  id                   String    @id @default(uuid())
  placeId              String    @unique @map("place_id")       // Google Places ID (dedupe key)
  campaignId           String?   @map("campaign_id")
  campaign             Campaign? @relation(fields: [campaignId], references: [id], onDelete: SetNull)
  campaignRunId        String?   @map("campaign_run_id")
  campaignRun          CampaignRun? @relation(fields: [campaignRunId], references: [id], onDelete: SetNull)
  searchQueryId        String?   @map("search_query_id")
  searchQuery          SearchQuery? @relation(fields: [searchQueryId], references: [id], onDelete: SetNull)
  franchiseId          String?   @map("franchise_id")
  franchise            Franchise? @relation(fields: [franchiseId], references: [id], onDelete: SetNull)

  // Business info (from Google Places)
  name                 String
  nameNormalized       String?   @map("name_normalized")  // lowercase, trimmed for franchise matching
  address              String?
  city                 String?
  state                String?
  zipCode              String?   @map("zip_code")
  phone                String?
  website              String?
  rating               Float?
  reviewCount          Int?      @map("review_count")
  priceLevel           Int?      @map("price_level")
  businessType         String?   @map("business_type")
  source               String?                                   // "google_places", "manual", "import"

  // Extended Places fields
  businessStatus       String?   @map("business_status")   // OPERATIONAL, CLOSED_PERMANENTLY, etc.
  latitude             Float?
  longitude            Float?
  primaryType          String?   @map("primary_type")      // Google type code
  openingHours         String?   @map("opening_hours")
  editorialSummary     String?   @map("editorial_summary")
  reviewSummary        String?   @map("review_summary")
  googleMapsUri        String?   @map("google_maps_uri")

  // AI Qualification (Claude scoring)
  qualificationScore   Int?      @map("qualification_score")     // 0-100
  qualificationNotes   String?   @map("qualification_notes")
  qualifiedAt          DateTime? @map("qualified_at")

  // Web Scraping
  webScrapedAt         DateTime? @map("web_scraped_at")
  webScrapedData       Json?     @map("web_scraped_data")        // Extracted data from website

  createdAt            DateTime  @default(now()) @map("created_at")
  updatedAt            DateTime  @updatedAt @map("updated_at")

  @@index([campaignId])
  @@index([campaignRunId])
  @@index([searchQueryId])
  @@index([franchiseId])
  @@index([nameNormalized])
  @@index([businessType])
  @@index([state])
  @@index([businessStatus])
  @@index([qualificationScore])
  @@index([createdAt])
  @@map("leads")
}

model Campaign {
  id                   String    @id @default(uuid())
  name                 String
  description          String?
  queriesS3Key         String?   @map("queries_s3_key")          // S3 key for searches JSON
  queriesCount         Int       @default(0) @map("queries_count")
  maxResultsPerSearch  Int       @default(60) @map("max_results_per_search")
  skipCachedSearches   Boolean   @default(false) @map("skip_cached_searches")
  createdById          String?   @map("created_by_id")

  createdAt            DateTime  @default(now()) @map("created_at")
  updatedAt            DateTime  @updatedAt @map("updated_at")

  leads                Lead[]
  runs                 CampaignRun[]
  searchQueries        SearchQuery[]
  jobs                 Job[]

  @@index([createdAt])
  @@map("campaigns")
}

model CampaignRun {
  id                   String    @id @default(uuid())
  campaignId           String    @map("campaign_id")
  campaign             Campaign  @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  startedById          String?   @map("started_by_id")

  status               String    @default("pending")             // pending, running, completed, failed
  startedAt            DateTime  @default(now()) @map("started_at")
  completedAt          DateTime? @map("completed_at")

  // Metrics
  queriesTotal         Int       @default(0) @map("queries_total")
  queriesExecuted      Int       @default(0) @map("queries_executed")
  leadsFound           Int       @default(0) @map("leads_found")
  duplicatesSkipped    Int       @default(0) @map("duplicates_skipped")
  errors               Int       @default(0)
  errorMessages        String[]  @default([]) @map("error_messages")

  leads                Lead[]
  searchQueries        SearchQuery[]
  jobs                 Job[]

  @@index([campaignId])
  @@index([status])
  @@index([startedAt])
  @@map("campaign_runs")
}

// ===========================================
// ASSETS (S3 file registry)
// ===========================================

model Asset {
  id          String      @id @default(uuid())
  fileName    String      @map("file_name")           // Original file name
  s3Key       String      @unique @map("s3_key")      // S3 object key (any prefix)
  fileType    String      @map("file_type")            // MIME type (e.g. application/pdf, image/png)
  fileSize    Int?        @map("file_size")             // Size in bytes
  category    String      @default("file")              // "file" or "photo"
  title       String?
  description String?
  uploadedBy  String?     @map("uploaded_by")
  isPublished Boolean     @default(true) @map("is_published")
  createdAt   DateTime    @default(now()) @map("created_at")
  updatedAt   DateTime    @updatedAt @map("updated_at")

  // Reverse relation: tombstones using this asset as their image
  tombstones  Tombstone[]

  @@index([category])
  @@map("assets")
}
