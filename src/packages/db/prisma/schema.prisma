// Prisma schema for FCA API
// https://pris.ly/d/prisma-schema

generator client {
  provider        = "prisma-client-js"
  binaryTargets   = ["native", "linux-arm64-openssl-3.0.x", "rhel-openssl-3.0.x"]
  previewFeatures = ["views"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ===========================================
// USER & AUTH
// ===========================================

model User {
  id             String    @id @default(uuid())
  email          String    @unique
  cognitoSub     String?   @unique @map("cognito_sub")
  role           UserRole  @default(readonly)
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  @@map("users")
}

// ===========================================
// GEOGRAPHY
// ===========================================

model State {
  id         String  @id           // e.g. "CO", "TX" (state_id from CSV)
  name       String  @unique       // e.g. "Colorado", "Texas"

  cities     City[]
  tombstones TombstoneState[]
  blogPosts  BlogPostState[]
  campaigns  CampaignState[]
  leads      Lead[]
  franchises FranchiseState[]

  @@map("states")
}

model City {
  id         Int     @id           // id column from CSV
  name       String                // city_ascii from CSV
  stateId    String  @map("state_id")
  state      State   @relation(fields: [stateId], references: [id])
  county     String?
  lat        Float?
  lng        Float?
  population Int?

  tombstones TombstoneCity[]
  blogPosts  BlogPostCity[]
  campaigns  CampaignCity[]
  leads      Lead[]
  franchises FranchiseCity[]

  @@unique([name, stateId])
  @@index([stateId])
  @@index([name])
  @@index([population(sort: Desc)])
  @@map("cities")
}

// ===========================================
// WEBSITE CONTENT
// ===========================================

model Tombstone {
  id              String    @id @default(uuid())
  name            String                          // Company/Seller name
  slug            String    @unique               // URL-friendly identifier
  assetId         String?   @map("asset_id")      // FK to Asset (tombstone image)
  asset           Asset?    @relation(fields: [assetId], references: [id], onDelete: SetNull)
  role            String?                         // Buy-side or Sell-side

  // Extended fields (from CSV data)
  buyerPeFirm     String?   @map("buyer_pe_firm")     // PE firm
  buyerPlatform   String?   @map("buyer_platform")    // Platform company
  transactionYear Int?      @map("transaction_year")  // Year of deal

  // Press release (1-to-1 relationship with BlogPost)
  pressReleaseId  String?   @unique @map("press_release_id")
  pressRelease    BlogPost? @relation(fields: [pressReleaseId], references: [id], onDelete: SetNull)

  sortOrder       Int       @default(0) @map("sort_order")
  isPublished     Boolean   @default(true) @map("is_published")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  // Many-to-many relationships
  industries      TombstoneIndustry[]
  dealTypes       TombstoneDealType[]
  locationCities  TombstoneCity[]
  locationStates  TombstoneState[]

  @@index([transactionYear])
  @@index([isPublished])
  @@map("tombstones")
}

model BlogPost {
  id           String    @id @default(uuid())
  slug         String    @unique
  title        String
  excerpt      String?
  content      String                          // Markdown content
  author       String?
  category     BlogPostCategory?
  publishedAt  DateTime? @map("published_at")
  isPublished  Boolean   @default(false) @map("is_published")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  // 1-to-1 reverse relation (this blog post is the press release for a tombstone)
  tombstone    Tombstone?

  // Many-to-many relationships
  industries      BlogPostIndustry[]
  locationCities  BlogPostCity[]
  locationStates  BlogPostState[]

  @@index([category, isPublished])
  @@index([isPublished, publishedAt(sort: Desc)])
  @@map("blog_posts")
}

// ===========================================
// INDUSTRY & DEAL TYPE
// ===========================================

model Industry {
  id        String   @id @default(uuid())
  name      String   @unique
  slug      String   @unique
  createdAt DateTime @default(now()) @map("created_at")

  tombstones TombstoneIndustry[]
  blogPosts  BlogPostIndustry[]

  @@map("industries")
}

model DealType {
  id        String   @id @default(uuid())
  name      String   @unique
  slug      String   @unique
  createdAt DateTime @default(now()) @map("created_at")

  tombstones TombstoneDealType[]

  @@map("deal_types")
}

model TombstoneIndustry {
  tombstoneId String    @map("tombstone_id")
  industryId  String    @map("industry_id")
  tombstone   Tombstone @relation(fields: [tombstoneId], references: [id], onDelete: Cascade)
  industry    Industry  @relation(fields: [industryId], references: [id], onDelete: Cascade)

  @@id([tombstoneId, industryId])
  @@index([industryId])
  @@map("tombstone_industries")
}

model TombstoneDealType {
  tombstoneId String    @map("tombstone_id")
  dealTypeId  String    @map("deal_type_id")
  tombstone   Tombstone @relation(fields: [tombstoneId], references: [id], onDelete: Cascade)
  dealType    DealType  @relation(fields: [dealTypeId], references: [id], onDelete: Cascade)

  @@id([tombstoneId, dealTypeId])
  @@index([dealTypeId])
  @@map("tombstone_deal_types")
}

model BlogPostIndustry {
  blogPostId String   @map("blog_post_id")
  industryId String   @map("industry_id")
  blogPost   BlogPost @relation(fields: [blogPostId], references: [id], onDelete: Cascade)
  industry   Industry @relation(fields: [industryId], references: [id], onDelete: Cascade)

  @@id([blogPostId, industryId])
  @@index([industryId])
  @@map("blog_post_industries")
}

// ===========================================
// LOCATION JUNCTION TABLES
// ===========================================

model TombstoneCity {
  tombstoneId String    @map("tombstone_id")
  cityId      Int       @map("city_id")
  tombstone   Tombstone @relation(fields: [tombstoneId], references: [id], onDelete: Cascade)
  city        City      @relation(fields: [cityId], references: [id], onDelete: Cascade)

  @@id([tombstoneId, cityId])
  @@index([cityId])
  @@map("tombstone_cities")
}

model TombstoneState {
  tombstoneId String    @map("tombstone_id")
  stateId     String    @map("state_id")
  tombstone   Tombstone @relation(fields: [tombstoneId], references: [id], onDelete: Cascade)
  state       State     @relation(fields: [stateId], references: [id], onDelete: Cascade)

  @@id([tombstoneId, stateId])
  @@index([stateId])
  @@map("tombstone_states")
}

model BlogPostCity {
  blogPostId String   @map("blog_post_id")
  cityId     Int      @map("city_id")
  blogPost   BlogPost @relation(fields: [blogPostId], references: [id], onDelete: Cascade)
  city       City     @relation(fields: [cityId], references: [id], onDelete: Cascade)

  @@id([blogPostId, cityId])
  @@index([cityId])
  @@map("blog_post_cities")
}

model BlogPostState {
  blogPostId String   @map("blog_post_id")
  stateId    String   @map("state_id")
  blogPost   BlogPost @relation(fields: [blogPostId], references: [id], onDelete: Cascade)
  state      State    @relation(fields: [stateId], references: [id], onDelete: Cascade)

  @@id([blogPostId, stateId])
  @@index([stateId])
  @@map("blog_post_states")
}

model CampaignCity {
  campaignId String   @map("campaign_id")
  cityId     Int      @map("city_id")
  campaign   Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  city       City     @relation(fields: [cityId], references: [id], onDelete: Cascade)

  @@id([campaignId, cityId])
  @@index([cityId])
  @@map("campaign_cities")
}

model CampaignState {
  campaignId String   @map("campaign_id")
  stateId    String   @map("state_id")
  campaign   Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  state      State    @relation(fields: [stateId], references: [id], onDelete: Cascade)

  @@id([campaignId, stateId])
  @@index([stateId])
  @@map("campaign_states")
}

model FranchiseCity {
  franchiseId String    @map("franchise_id")
  cityId      Int       @map("city_id")
  franchise   Franchise @relation(fields: [franchiseId], references: [id], onDelete: Cascade)
  city        City      @relation(fields: [cityId], references: [id], onDelete: Cascade)

  @@id([franchiseId, cityId])
  @@index([cityId])
  @@map("franchise_cities")
}

model FranchiseState {
  franchiseId String    @map("franchise_id")
  stateId     String    @map("state_id")
  franchise   Franchise @relation(fields: [franchiseId], references: [id], onDelete: Cascade)
  state       State     @relation(fields: [stateId], references: [id], onDelete: Cascade)

  @@id([franchiseId, stateId])
  @@index([stateId])
  @@map("franchise_states")
}

model PageContent {
  id        String   @id @default(uuid())
  pageKey   String   @unique @map("page_key") // home, about, faq, contact, etc.
  title     String
  content   String   @default("")             // Markdown or prose content
  metadata  Json?                             // SEO metadata, hero settings, structured data
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("page_content")
}

// ===========================================
// ANALYTICS
// ===========================================

model PageView {
  id        String   @id @default(uuid())
  path      String
  hour      DateTime                          // Truncated to hour for aggregation
  count     Int      @default(1)
  createdAt DateTime @default(now()) @map("created_at")

  @@unique([path, hour])
  @@index([hour])
  @@map("page_views")
}

// ===========================================
// EMAIL & NEWSLETTER
// ===========================================

model EmailSubscriber {
  id             String    @id @default(uuid())
  email          String    @unique
  name           String?
  source         String?                        // website, intake_form, manual
  isSubscribed   Boolean   @default(true) @map("is_subscribed")
  subscribedAt   DateTime  @default(now()) @map("subscribed_at")
  unsubscribedAt DateTime? @map("unsubscribed_at")

  @@map("email_subscribers")
}

model SellerIntake {
  id             String   @id @default(uuid())

  // Contact Information
  firstName      String   @map("first_name")
  lastName       String   @map("last_name")
  email          String
  phone          String?

  // Company Information
  companyName    String   @map("company_name")
  title          String?                        // Their role (Owner, CEO, CFO, etc.)
  industry       String?
  city           String?
  state          String?

  // Business Details
  revenueRange   String?  @map("revenue_range")
  employeeCount  String?  @map("employee_count")

  // Transaction Interest
  timeline       String?
  serviceInterest String? @map("service_interest")

  // Additional
  message        String?
  source         String?                        // Which form/page
  referralSource String?  @map("referral_source")

  // Internal Tracking
  status         String   @default("new")       // new, contacted, qualified, engaged, closed
  notes          String?
  assignedTo     String?  @map("assigned_to")

  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  @@index([status])
  @@index([createdAt])
  @@map("seller_intakes")
}

model EmailNotification {
  id             String   @id @default(uuid())
  type           String                          // new_tombstone, new_blog_post
  referenceId    String   @map("reference_id")
  sentAt         DateTime @default(now()) @map("sent_at")
  recipientCount Int      @map("recipient_count")

  @@map("email_notifications")
}

// ===========================================
// STATIC PAGE CONTENT
// ===========================================

model TeamMember {
  id          String   @id @default(uuid())
  name        String
  title       String
  image       String?                           // Path to team member photo
  bio         String                            // Full biography text
  email       String?
  linkedIn    String?  @map("linkedin")
  category    String   @default("leadership")   // leadership, analyst
  sortOrder   Int      @default(0) @map("sort_order")
  isPublished Boolean  @default(true) @map("is_published")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@index([category, sortOrder])
  @@map("team_members")
}

model CommunityService {
  id          String   @id @default(uuid())
  name        String
  description String
  url         String
  sortOrder   Int      @default(0) @map("sort_order")
  isPublished Boolean  @default(true) @map("is_published")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("community_services")
}

model FAQ {
  id          String   @id @default(uuid())
  question    String
  answer      String
  sortOrder   Int      @default(0) @map("sort_order")
  isPublished Boolean  @default(true) @map("is_published")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("faqs")
}

model CoreValue {
  id          String   @id @default(uuid())
  title       String
  description String
  icon        String                            // Path to icon image
  sortOrder   Int      @default(0) @map("sort_order")
  isPublished Boolean  @default(true) @map("is_published")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("core_values")
}

model IndustrySector {
  id          String   @id @default(uuid())
  name        String
  description String
  sortOrder   Int      @default(0) @map("sort_order")
  isPublished Boolean  @default(true) @map("is_published")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("industry_sectors")
}

model ServiceOffering {
  id          String   @id @default(uuid())
  title       String
  description String?
  category    String                            // sell-side, buy-side, strategic
  type        String   @default("service")      // service, process-step, benefit, disadvantage
  step        Int?                              // For process steps (1, 2, 3, 4)
  sortOrder   Int      @default(0) @map("sort_order")
  isPublished Boolean  @default(true) @map("is_published")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@index([category, type, sortOrder])
  @@map("service_offerings")
}

model SiteConfig {
  id            String   @id @default("default")  // Single-row config
  name          String                            // Company name
  tagline       String?
  url           String                            // Website URL
  description   String?
  phone         String?
  email         String?
  linkedIn      String?  @map("linkedin")
  ogImage       String?  @map("og_image")
  locations     Json     @default("[]")           // [{city, state}]
  navItems      Json     @default("[]")           // [{name, href}]
  footerNav     Json     @default("{}")           // {services: [], company: [], resources: []}
  serviceTypes  Json     @default("[]") @map("service_types")   // ["Mergers and Acquisitions Advisory", ...]
  companyBlurb  String?  @map("company_blurb")                  // Short company description for sidebars
  updatedAt     DateTime @updatedAt @map("updated_at")

  @@map("site_config")
}

model Award {
  id          String   @id @default(uuid())
  name        String                            // Display name (e.g. "Axial Top 10 Investment Bank 2022")
  image       String                            // URL or path to award image
  sortOrder   Int      @default(0) @map("sort_order")
  isPublished Boolean  @default(true) @map("is_published")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("awards")
}

// ===========================================
// LEAD GENERATION
// ===========================================

model SearchQuery {
  id           String    @id @default(uuid())
  textQuery    String    @map("text_query")
  includedType String?   @map("included_type")
  campaignId   String    @map("campaign_id")
  campaign     Campaign  @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  campaignRunId String?   @map("campaign_run_id")
  campaignRun   CampaignRun? @relation(fields: [campaignRunId], references: [id], onDelete: SetNull)

  createdAt    DateTime  @default(now()) @map("created_at")

  leads        Lead[]

  @@index([campaignId])
  @@index([campaignRunId])
  @@index([textQuery])
  @@map("search_queries")
}

model Franchise {
  id          String   @id @default(uuid())
  name        String   // normalized for matching (e.g. "xyz plumbing")
  displayName String?  @map("display_name")  // original (e.g. "XYZ Plumbing")

  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  leads          Lead[]
  scrapedPages   FranchiseScrapedPage[]
  locationCities FranchiseCity[]
  locationStates FranchiseState[]

  @@unique([name])
  @@map("franchises")
}

model ScrapeRun {
  id            String    @id @default(uuid())
  leadId        String    @map("lead_id")
  lead          Lead      @relation(fields: [leadId], references: [id], onDelete: Cascade)
  taskId        String?   @map("task_id")
  rootUrl       String    @map("root_url")
  status        ScrapeRunStatus @default(running)
  startedAt     DateTime  @default(now()) @map("started_at")
  completedAt   DateTime? @map("completed_at")
  methodSummary String?   @map("method_summary")
  pagesCount    Int?      @map("pages_count")
  durationMs    Int?      @map("duration_ms")

  scrapedPages ScrapedPage[]

  @@index([leadId, startedAt])
  @@index([status])
  @@index([taskId])
  @@map("scrape_runs")
}

model ScrapedPage {
  id                   String        @id @default(uuid())
  scrapeRunId          String        @map("scrape_run_id")
  scrapeRun            ScrapeRun     @relation(fields: [scrapeRunId], references: [id], onDelete: Cascade)
  leadId               String        @map("lead_id")
  lead                 Lead          @relation(fields: [leadId], references: [id], onDelete: Cascade)
  parentScrapedPageId  String?       @map("parent_scraped_page_id")
  parentScrapedPage    ScrapedPage?  @relation("ScrapedPageTree", fields: [parentScrapedPageId], references: [id], onDelete: SetNull)
  childPages           ScrapedPage[] @relation("ScrapedPageTree")
  depth                Int           @default(0)
  linkText             String?       @map("link_text")
  anchorText           String?       @map("anchor_text")
  discoveredFromUrl    String?       @map("discovered_from_url")
  url                  String
  domain               String
  scrapeMethod         String        @map("scrape_method")   // cloudscraper | puppeteer
  statusCode           Int?          @map("status_code")
  scrapedAt            DateTime      @map("scraped_at")
  durationMs           Int?          @map("duration_ms")
  markdownS3Key        String?       @map("markdown_s3_key")

  franchises           FranchiseScrapedPage[]
  leadEmails           LeadEmail[]
  leadPhones           LeadPhone[]
  leadSocialProfiles   LeadSocialProfile[]

  createdAt            DateTime      @default(now()) @map("created_at")

  @@unique([scrapeRunId, url])
  @@index([domain])
  @@index([scrapedAt])
  @@index([parentScrapedPageId])
  @@index([leadId, scrapedAt])
  @@map("scraped_pages")
}

model FranchiseScrapedPage {
  franchiseId   String     @map("franchise_id")
  franchise     Franchise  @relation(fields: [franchiseId], references: [id], onDelete: Cascade)
  scrapedPageId String     @map("scraped_page_id")
  scrapedPage   ScrapedPage @relation(fields: [scrapedPageId], references: [id], onDelete: Cascade)

  @@id([franchiseId, scrapedPageId])
  @@index([scrapedPageId])
  @@map("franchise_scraped_pages")
}

model LeadEmail {
  id             String      @id @default(uuid())
  leadId         String      @map("lead_id")
  lead           Lead        @relation(fields: [leadId], references: [id], onDelete: Cascade)
  value          String
  sourcePageId   String      @map("source_page_id")
  sourcePage     ScrapedPage @relation(fields: [sourcePageId], references: [id], onDelete: Cascade)
  sourceRunId    String      @map("source_run_id")
  createdAt      DateTime    @default(now()) @map("created_at")

  @@unique([leadId, value], name: "leadId_value")
  @@index([leadId])
  @@index([sourcePageId])
  @@index([sourceRunId])
  @@map("lead_emails")
}

model LeadPhone {
  id             String      @id @default(uuid())
  leadId         String      @map("lead_id")
  lead           Lead        @relation(fields: [leadId], references: [id], onDelete: Cascade)
  value          String
  sourcePageId   String      @map("source_page_id")
  sourcePage     ScrapedPage @relation(fields: [sourcePageId], references: [id], onDelete: Cascade)
  sourceRunId    String      @map("source_run_id")
  createdAt      DateTime    @default(now()) @map("created_at")

  @@unique([leadId, value], name: "leadId_value")
  @@index([leadId])
  @@index([sourcePageId])
  @@index([sourceRunId])
  @@map("lead_phones")
}

model LeadSocialProfile {
  id             String      @id @default(uuid())
  leadId         String      @map("lead_id")
  lead           Lead        @relation(fields: [leadId], references: [id], onDelete: Cascade)
  platform       String      // linkedin, facebook, instagram, twitter
  url            String
  sourcePageId   String      @map("source_page_id")
  sourcePage     ScrapedPage @relation(fields: [sourcePageId], references: [id], onDelete: Cascade)
  sourceRunId    String      @map("source_run_id")
  createdAt      DateTime    @default(now()) @map("created_at")

  @@index([leadId])
  @@index([sourcePageId])
  @@index([sourceRunId])
  @@map("lead_social_profiles")
}


enum UserRole {
  readonly
  readwrite
  admin
}

enum ScrapeRunStatus {
  running
  completed
  failed
}

enum CampaignRunStatus {
  pending
  running
  completed
  failed
}

enum LeadPipelineStatus {
  idle
  queued_for_scrape
  scraping
  queued_for_scoring
  scoring
  scrape_failed
  scoring_failed
}

enum LeadSource {
  google_places
  manual
  import
}

enum BlogPostCategory {
  news
  resource
  article
}

enum FargateTaskType {
  places_search
  web_scrape
  ai_scoring
}

enum FargateTaskStatus {
  pending
  running
  completed
  failed
  cancelled
}

model FargateTask {
  id             String             @id @default(uuid())
  type           FargateTaskType
  status         FargateTaskStatus   @default(pending)
  taskArn        String?             @map("task_arn")
  startedAt      DateTime?           @map("started_at")
  completedAt    DateTime?          @map("completed_at")
  errorMessage   String?             @map("error_message")
  metadata       Json?

  createdAt      DateTime            @default(now()) @map("created_at")
  updatedAt      DateTime            @updatedAt @map("updated_at")

  @@index([type])
  @@index([status])
  @@index([createdAt])
  @@map("fargate_tasks")
}

model Lead {
  id                   String    @id @default(uuid())
  placeId              String    @unique @map("place_id")       // Google Places ID (dedupe key)
  campaignId           String?   @map("campaign_id")
  campaign             Campaign? @relation(fields: [campaignId], references: [id], onDelete: SetNull)
  campaignRunId        String?   @map("campaign_run_id")
  campaignRun          CampaignRun? @relation(fields: [campaignRunId], references: [id], onDelete: SetNull)
  searchQueryId        String?   @map("search_query_id")
  searchQuery          SearchQuery? @relation(fields: [searchQueryId], references: [id], onDelete: SetNull)
  franchiseId          String?   @map("franchise_id")
  franchise            Franchise? @relation(fields: [franchiseId], references: [id], onDelete: SetNull)

  scrapeRuns           ScrapeRun[]
  scrapedPages         ScrapedPage[]
  leadEmails           LeadEmail[]
  leadPhones           LeadPhone[]
  leadSocialProfiles   LeadSocialProfile[]

  // Normalized location FKs
  locationCityId       Int?      @map("location_city_id")
  locationCity         City?     @relation(fields: [locationCityId], references: [id], onDelete: SetNull)
  locationStateId      String?   @map("location_state_id")
  locationState        State?    @relation(fields: [locationStateId], references: [id], onDelete: SetNull)

  // Business info (from Google Places)
  name                 String
  nameNormalized       String?   @map("name_normalized")  // lowercase, trimmed for franchise matching
  address              String?
  zipCode              String?   @map("zip_code")
  phone                String?
  website              String?
  rating               Float?
  reviewCount          Int?      @map("review_count")
  priceLevel           Int?      @map("price_level")
  businessType         String?   @map("business_type")
  source               LeadSource?

  // Extended Places fields
  businessStatus       String?   @map("business_status")   // OPERATIONAL, CLOSED_PERMANENTLY, etc.
  latitude             Float?
  longitude            Float?
  primaryType          String?   @map("primary_type")      // Google type code
  openingHours         String?   @map("opening_hours")
  editorialSummary     String?   @map("editorial_summary")
  reviewSummary        String?   @map("review_summary")
  googleMapsUri        String?   @map("google_maps_uri")

  // AI Scoring (Claude PE lead qualification)
  controllingOwner     String?   @map("controlling_owner")
  ownershipType        String?   @map("ownership_type")
  isExcluded           Boolean   @default(false) @map("is_excluded")
  exclusionReason      String?   @map("exclusion_reason")
  businessQualityScore Int?      @map("business_quality_score")
  exitReadinessScore   Int?      @map("exit_readiness_score")
  scoringRationale     String?   @map("scoring_rationale")
  supportingEvidence   Json?     @map("supporting_evidence")
  scrapeMarkdownS3Key  String?   @map("scrape_markdown_s3_key")
  extractedFactsS3Key  String?   @map("extracted_facts_s3_key")
  scoredAt             DateTime? @map("scored_at")

  // Relative scoring (percentile ranks within cohorts, 0-100)
  qualityPercentileByType  Float?   @map("quality_percentile_by_type")
  qualityPercentileByCity  Float?   @map("quality_percentile_by_city")
  exitPercentileByType     Float?   @map("exit_percentile_by_type")
  exitPercentileByCity     Float?   @map("exit_percentile_by_city")
  compositeScore           Float?   @map("composite_score")

  // Web Scraping
  webScrapedAt         DateTime? @map("web_scraped_at")
  contactPageUrl       String?   @map("contact_page_url")
  pipelineStatus       LeadPipelineStatus @default(idle) @map("pipeline_status")
  scrapeError          String?   @map("scrape_error")
  scoringError         String?   @map("scoring_error")

  createdAt            DateTime  @default(now()) @map("created_at")
  updatedAt            DateTime  @updatedAt @map("updated_at")

  @@index([campaignId])
  @@index([campaignRunId])
  @@index([searchQueryId])
  @@index([franchiseId])
  @@index([locationCityId])
  @@index([locationStateId])
  @@index([nameNormalized])
  @@index([businessType])
  @@index([businessStatus])
  @@index([isExcluded])
  @@index([scoredAt])
  @@index([createdAt])
  @@index([pipelineStatus])
  @@index([compositeScore])
  @@map("leads")
}

model Campaign {
  id                   String    @id @default(uuid())
  name                 String
  description          String?
  queriesS3Key         String?   @map("queries_s3_key")          // S3 key for searches JSON
  queriesCount         Int       @default(0) @map("queries_count")
  maxResultsPerSearch  Int       @default(60) @map("max_results_per_search")
  maxTotalRequests     Int?      @map("max_total_requests")      // Total API request budget across all queries
  skipCachedSearches   Boolean   @default(false) @map("skip_cached_searches")
  enableWebScraping    Boolean   @default(true) @map("enable_web_scraping")
  enableAiScoring      Boolean   @default(false) @map("enable_ai_scoring")
  createdById          String?   @map("created_by_id")

  createdAt            DateTime  @default(now()) @map("created_at")
  updatedAt            DateTime  @updatedAt @map("updated_at")

  leads                Lead[]
  runs                 CampaignRun[]
  searchQueries        SearchQuery[]
  locationCities       CampaignCity[]
  locationStates       CampaignState[]

  @@index([createdAt])
  @@map("campaigns")
}

model CampaignRun {
  id                   String    @id @default(uuid())
  campaignId           String    @map("campaign_id")
  campaign             Campaign  @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  startedById          String?   @map("started_by_id")

  status               CampaignRunStatus @default(pending)
  startedAt            DateTime  @default(now()) @map("started_at")
  completedAt          DateTime? @map("completed_at")

  // Metrics
  queriesTotal         Int       @default(0) @map("queries_total")
  queriesExecuted      Int       @default(0) @map("queries_executed")
  leadsFound           Int       @default(0) @map("leads_found")
  duplicatesSkipped    Int       @default(0) @map("duplicates_skipped")
  errors               Int       @default(0)
  errorMessages        String[]  @default([]) @map("error_messages")

  leads                Lead[]
  searchQueries        SearchQuery[]

  @@index([campaignId])
  @@index([status])
  @@index([startedAt])
  @@map("campaign_runs")
}

// ===========================================
// ASSETS (S3 file registry)
// ===========================================

// ===========================================
// MARKET INTELLIGENCE (scoring context)
// ===========================================

view MarketStatsByType {
  businessType String @id @map("business_type")

  leadCount    Int   @map("lead_count")
  rcP00        Float @map("rc_p00")
  rcP01        Float @map("rc_p01")
  rcP05        Float @map("rc_p05")
  rcP10        Float @map("rc_p10")
  rcP15        Float @map("rc_p15")
  rcP20        Float @map("rc_p20")
  rcP25        Float @map("rc_p25")
  rcP30        Float @map("rc_p30")
  rcP35        Float @map("rc_p35")
  rcP40        Float @map("rc_p40")
  rcP45        Float @map("rc_p45")
  rcP50        Float @map("rc_p50")
  rcP55        Float @map("rc_p55")
  rcP60        Float @map("rc_p60")
  rcP65        Float @map("rc_p65")
  rcP70        Float @map("rc_p70")
  rcP75        Float @map("rc_p75")
  rcP80        Float @map("rc_p80")
  rcP85        Float @map("rc_p85")
  rcP90        Float @map("rc_p90")
  rcP95        Float @map("rc_p95")
  rcP99        Float @map("rc_p99")
  rcP999       Float @map("rc_p999")
  ratingMean   Float @map("rating_mean")
  ratingMedian Float @map("rating_median")

  @@map("market_stats_by_type")
}

view MarketStatsByState {
  locationStateId String @id @map("location_state_id")

  leadCount       Int   @map("lead_count")
  rcP00           Float @map("rc_p00")
  rcP01           Float @map("rc_p01")
  rcP05           Float @map("rc_p05")
  rcP10           Float @map("rc_p10")
  rcP15           Float @map("rc_p15")
  rcP20           Float @map("rc_p20")
  rcP25           Float @map("rc_p25")
  rcP30           Float @map("rc_p30")
  rcP35           Float @map("rc_p35")
  rcP40           Float @map("rc_p40")
  rcP45           Float @map("rc_p45")
  rcP50           Float @map("rc_p50")
  rcP55           Float @map("rc_p55")
  rcP60           Float @map("rc_p60")
  rcP65           Float @map("rc_p65")
  rcP70           Float @map("rc_p70")
  rcP75           Float @map("rc_p75")
  rcP80           Float @map("rc_p80")
  rcP85           Float @map("rc_p85")
  rcP90           Float @map("rc_p90")
  rcP95           Float @map("rc_p95")
  rcP99           Float @map("rc_p99")
  rcP999          Float @map("rc_p999")
  ratingMean      Float @map("rating_mean")
  ratingMedian    Float @map("rating_median")

  @@map("market_stats_by_state")
}

view MarketStatsByCity {
  locationStateId String @map("location_state_id")
  locationCityId  Int    @map("location_city_id")

  leadCount       Int   @map("lead_count")
  rcP00           Float @map("rc_p00")
  rcP01           Float @map("rc_p01")
  rcP05           Float @map("rc_p05")
  rcP10           Float @map("rc_p10")
  rcP15           Float @map("rc_p15")
  rcP20           Float @map("rc_p20")
  rcP25           Float @map("rc_p25")
  rcP30           Float @map("rc_p30")
  rcP35           Float @map("rc_p35")
  rcP40           Float @map("rc_p40")
  rcP45           Float @map("rc_p45")
  rcP50           Float @map("rc_p50")
  rcP55           Float @map("rc_p55")
  rcP60           Float @map("rc_p60")
  rcP65           Float @map("rc_p65")
  rcP70           Float @map("rc_p70")
  rcP75           Float @map("rc_p75")
  rcP80           Float @map("rc_p80")
  rcP85           Float @map("rc_p85")
  rcP90           Float @map("rc_p90")
  rcP95           Float @map("rc_p95")
  rcP99           Float @map("rc_p99")
  rcP999          Float @map("rc_p999")
  ratingMean      Float @map("rating_mean")
  ratingMedian    Float @map("rating_median")

  @@id([locationStateId, locationCityId])
  @@map("market_stats_by_city")
}

// ===========================================
// ASSETS (S3 file registry)
// ===========================================

model Asset {
  id          String      @id @default(uuid())
  fileName    String      @map("file_name")           // Original file name
  s3Key       String      @unique @map("s3_key")      // S3 object key (any prefix)
  fileType    String      @map("file_type")            // MIME type (e.g. application/pdf, image/png)
  fileSize    Int?        @map("file_size")             // Size in bytes
  category    String      @default("file")              // "file" or "photo"
  title       String?
  description String?
  uploadedBy  String?     @map("uploaded_by")
  isPublished Boolean     @default(true) @map("is_published")
  createdAt   DateTime    @default(now()) @map("created_at")
  updatedAt   DateTime    @updatedAt @map("updated_at")

  // Reverse relation: tombstones using this asset as their image
  tombstones  Tombstone[]

  @@index([category])
  @@map("assets")
}
